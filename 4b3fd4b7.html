<!DOCTYPE html>
<html ng-app="ionicApp">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /> 
<meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no, width=device-width" />
<title>Anyprint</title>
<link href="./css/jquery.mobile-1.4.5.min.css" rel="stylesheet">
<script src="./js/jquery-2.1.3.js"></script>
<script src="./js/jquery.mobile-1.4.5.min.js"></script>
<style>
.ui-icon-pause:after {
	background-image:url(images/pause.png);
	background-size:25px 25px;
}
.ui-icon-stop:after {
	background-image:url(images/stop.png);
	background-size:25px 25px;
}
#info {
	line-height:30px;
	border:1px solid #CCC;
	width:100%;
	padding:10px;
	background-color:#EEE;
}
#file-list {
	list-style:none;
}
#file-list li div {
	height: 35px;
	border-bottom: 1px dotted #CCC;
	line-height: 35px;
}
</style>
</head>
<body>
<div data-role="page" id="pageone">
  <div data-role="header">
    <div><span style="height:30px; display:block; line-height:30px; text-align:center; font-size:12.5px;" name="title">MiCOKit08</span></div>
    <div data-role="navbar">
      <ul>
        <li><a href="#" class="ui-btn-active ui-state-persist" data-icon="home">��ҳ</a></li>
        <li><a href="#pagetwo" data-icon="grid" data-transition="none" >�ļ��б�</a></li>
      </ul>
    </div>
  </div>
  <div data-role="content">
    <div class="ui-block-b" id="info"> ��ͷ�¶ȣ�<span id="lt"></span>��<br/>
      ��ͷ�¶ȣ�<span id="rt"></span>��<br/>
      �װ��¶ȣ�<span id="pt"></span>��<br/>
      <span id="stlfile"></span> ״̬��<span id="printstate"></span>&nbsp;&nbsp;<br/>
      <span id="ppercent"></span><br/>
    </div>
    <span style="clear:both;"></span>
    <div class="ui-block-c" style="max-height:300px; line-height:20px;">
      <p>������¼</p>
      <div id="debug"> </div>
    </div>
  </div>
  <div data-role="footer" data-position="fixed" data-tap-toggle="false">
    <div data-role="navbar" id="sp">
      <ul style="display:none;">
        <li>
          <button href="#" data-icon="pause" id="pause">��ͣ/����</button>
        </li>
        <li>
          <button href="#" data-icon="stop" id="stop">ȡ����ӡ</button>
        </li>
      </ul>
    </div>
    <h1 style="font-size:6px;">��Ȩ���� &copy; �ൺ����Ƽ����޹�˾</h1>
  </div>
</div>
<div data-role="page" id="pagetwo">
  <div data-role="header">
    <div><span style="height:30px; display:block; line-height:30px; text-align:center; font-size:12.5px;" name="title">MiCOKit08</span></div>
    <div data-role="navbar">
      <ul>
        <li><a href="#pageone" data-icon="home" data-transition="none" >��ҳ</a></li>
        <li><a href="#" class="ui-btn-active ui-state-persist" data-icon="grid">�ļ��б�</a></li>
      </ul>
    </div>
  </div>
  <div data-role="content">
    <div id="file-info"></div>
    <div id="file-list" data-role="collapsible" data-collapsed="false">
      <h1>�ļ��б�</h1>
      <p>
      <ul id="file-list">
      </ul>
      </p>
    </div>
  </div>
  <div data-role="footer" data-position="fixed" data-tap-toggle="false">
    <div data-role="navbar">
      <ul>
        <li>
          <button href="#" data-icon="grid" id="getfiles">��ȡ�ļ��б�</button>
        </li>
        <!--<li><a href="#" data-icon="" id="stop">ֹͣ��ӡ</a></li>-->
      </ul>
    </div>
    <h1 style="font-size:6px;">��Ȩ���� &copy; �ൺ����Ƽ����޹�˾</h1>
  </div>
</div>
</body>
<script src="./js/mqttws31.js"></script>
<script src="./js/crc.js"></script>
<script>
<!--
	var commondQueue=new Array();
	var returnQueue=new Array();
	var stateType={
		init:-1,//��ʼ״̬
		idle:0,//����
		printing:1,//���ڴ�ӡ
		paused:2,//��ͣ��ӡ
		pausing:3,//׼����ͣ
		restore:4,//�ָ���ӡ
	}
	/**��ʱ����ָ��*/
	var timeer;//д��ָ��
	var timeer2;//����ָ��

    // ��url�л�ȡĳ��������ֵ
    function getParameterByName(name) {
        var match = RegExp('[?&]' + name + '=([^&]*)').exec(window.location.search);
        return match && decodeURIComponent(match[1].replace(/\+/g, ' '));
    }
   // �õ��豸ID
    var device_id = getParameterByName('device_id');
	var alias=getParameterByName('alias');

	var access_token;//΢��token
	var clientID;//�ͻ���ʶ���
	var client;//�ͻ���
	var ez_connect=ez_connect;
	
	var fileFlag=true;//�Ƿ����»�ȡ�ļ��б�
	var state=stateType.init;//��ӡ״̬

	device_id="4b3fd4b7/c8934652e262";//����������� 
	//device_id="555397aa/d0bae4003738";//���ز�������
	
	$("span[name='title']").html(alias);//�޸�title
	
    // ����豸ID��Ϊ�գ���ִ������MQTT�Ĳ���
    if ( device_id !== null ){
       	ez_connect(device_id); 
    }

    // ����MQTT����
   	function ez_connect(device_id) {
        // ��ȡaccess_token
        // access_token�ǹ��ںŵ�ȫ��ΨһƱ�ݣ����ںŵ��ø��ӿ�ʱ����ʹ��access_token��
        // ���������access_token��Ч��Ϊ7200�룬�ظ���ȡ�������ϴλ�ȡ��access_tokenʧЧ
        access_token = getParameterByName('access_token');
		
        // websocket����
        // wsbroker:host
        // wsport:�˿� Ĭ��1983
        // Client-ID �� v1_web_[MAC]  //�汾��_app_�ֻ�MAC(������12λСд)
        var wsbroker = "api.easylink.io";  //mqtt websocket enabled broker
        var wsport = 1983 // port for above
		
		//if(clientID == null || clientID.trim ==""){
		clientID="v1web" + parseInt(Math.random() * 1000000, 12);
		//}
        client = new Paho.MQTT.Client(wsbroker, wsport, clientID);

        // ������������
        // ���Ӷ�ʧ����Ӧ��callback����
        client.onConnectionLost = onConnectionLost;
        // ��Ϣ��������Ӧ��callback����
        client.onMessageArrived = onMessageArrived;
        // ���ӳɹ�����Ӧ��callback����
        client.connect({onSuccess:onConnect});

        // ���ӳɹ�
        function onConnect() {
            var subtopic = device_id+'/out/#';
            // Once a connection has been made, make a subscription and send a message.
            // ��ĳ��ͨ������ָ��
            // topic��ͨ��
            // commond��ָ��
            client.publish = function(topic, commond) {
				//console.log("����ִ��-->:"+commond);
				returnQueue.push(commondQueue.shift());
                message = new Paho.MQTT.Message(commond);
                message.destinationName = topic;
                client.send(message);
            }
           	//console.log("device_id:"+device_id);
            console.log("���ӳɹ���");
            client.subscribe(subtopic, {qos: 0});
        }
        // ���Ӷ�ʧ
        function onConnectionLost(responseObject) {
            if (responseObject.errorCode !== 0){
				//���豸�ѶϿ����ӣ����������ӣ�responseObject.errorMessage
                console.log("���豸�ѶϿ����ӣ�����������.....");
				//��������
				ez_connect(device_id); 
			}
        }
		
        // ��Ϣ����
        function onMessageArrived(message) {
			var result=message.payloadString;
			result=eval("result="+result);
			if(result.id != null  && result.id==clientID){
				//console.log('��������<--:' +  message.payloadString);	
				
				//�ļ��б�
				//ÿ�λ�ȡһ�飬��ȡ֮��,�ڻ�ȡ��һ����next,
				//�ļ��б�����ֿգ����ٻ�ȡ
				if(result.Files !=null && result.getFiles == 'ok'){
					var next=true;
					var filelist=new Array();
					for(var i in result.Files){
						if(result.Files[i] == 'NULL'){
							next=false;
						}else{
							filelist.push(result.Files[i]);
						}
					}
					$("#file-info").html("");
					showFileList(filelist);
					if(next){
						mgetFiles('next');
					}
				}
				//��ӡ�ļ�
				
			}else if(result.id == null){
				//�����ʱ���ص�����
				//console.log('��������<--:' +  message.payloadString);	
				
				//��ͷ�¶�
				if(result.tempLN !=null){
					$("#lt").html(result.tempLN);
				}
				
				//��ͷ�¶�
				if(result.tempRN !=null){
					$("#rt").html(result.tempRN);
				}
				
				//�װ��¶�
				if(result.tempFN !=null){
					$("#pt").html(result.tempFN);
				}
				
				//״̬
				if(result.state !=null){
					switch(result.state){
						case stateType.idle:
							$("#printstate").html("����");
							$("#sp ul").css("display","none");
							break;
						case stateType.printing:
							$("#printstate").html("���ڴ�ӡ");
							$("#sp ul").css("display","");
							break;
						case stateType.paused:
							$("#printstate").html("��ͣ��ӡ");
							$("#sp ul").css("display","");
							break;
						case stateType.pausing:
							$("#printstate").html("׼����ͣ�����Ե�...");
							$("#sp ul").css("display","none");
							break;
						case stateType.restore:
							$("#printstate").html("�ָ���ӡ��������...");
							$("#sp ul").css("display","none");
							break;
					}
					state=result.state;
				}
				
				//��ӡ����
				if(result.per !=null){
					$("#ppercent").html("��ӡ���ȣ�"+result.per+"%");
				}else{
					$("#ppercent").html("");
				}
				
				//��ӡ�ļ�
				if(result.printingFile !=null && result.printingFile.trim() !=""){
					$("#stlfile").html("��ӡ�ļ���"+result.printingFile+"<br/>");
				}else{
					$("#stlfile").html("");
				}
			}
        }

        // �������ݷ��Ͳ���
        //var inputMessage = document.getElementById('message');
        // ����Ϣ���͵�ָ����ͨ��
      	function send2uart(commond) {
            var topic = device_id+'/in';
			commond.id=clientID;
			client.publish(topic, JSON.stringify(commond));
        }
		
		function mpause(){
			var commond=new Object();
			commond.printPC='NULL';
			console.log("��ͣ/����");	
			send2uart(commond);
		}
		//��ͣ
		document.querySelector('#pause').addEventListener('click', mpause);
				
		function mstop(){
			if(confirm("�Ƿ�ȡ���ļ���ӡ?")){
				var commond=new Object();
				commond.printS='NULL';
				console.log("ȡ����ӡ");			
				send2uart(commond);
			}
		}
		//ֹͣ
		document.querySelector('#stop').addEventListener('click', mstop);
	   
	   	function mgetFiles(indicate){
			if(indicate == 'first'){
				fileFlag=true;
			}else{
				fileFlag=false;
			}
			var commond=new Object();
			commond.getFiles=indicate;
			
			if(state == stateType.idle ){//����ʱ��ѯ
				if(indicate == 'first'){
					$("#file-info").html("���ڻ�ȡ�ļ��б�����Ժ�...");
				}
				send2uart(commond);
			}else{
				$("#file-info").html("������æ�����Ժ�����");
				console.log("������æ�����Ժ�����");
			}
		}
		//��ȡ�ļ��б�
		document.querySelector('#getfiles').addEventListener('click',function(){mgetFiles('first')});
		
		
		function printFile(fileName){
			var commond=new Object();
			commond.printFile=fileName;
			if(state ==stateType.idle ){//����ʱ��ӡ
				if(confirm("��ӡ�ļ�"+fileName+"��?")){
					console.log("��ӡ�ļ���"+fileName);
					send2uart(commond);
					window.location.hash = "pageone";
				}
			}else{
				$("#file-info").html("������æ�����Ժ�����");
				console.log("������æ�����Ժ�����");
			}
		}
		
		var index=0;
		//��ʾ�ļ��б�
		function showFileList(alist){
			if(fileFlag){
				$("#file-list ul").empty();
				index=0;
			}
			for(var i=0;i<alist.length;i++){
				var fileName=alist[i].trim();
				$("#file-list ul").append("<li><div data-role=\"collapsible\" data-collapsed=\"true\"><span name=\"filename\">"+fileName+"</span><a name=\"printfile"+index+"\" style=\"float:right;\">��ӡ</a></div></li>");
				$("a[name='printfile"+index+"']").bind('click',{name:fileName},function(e){
						var fileName=e.data.name; 
						printFile(fileName);
				});
				index++;
			}
		}
		
		//�ļ��б�
	   	$("h1[name='filename']").click(function(){
			current_file=$(this).children().html();
			current_file=current_file.substr(0,current_file.indexOf("<")).trim();			
		  	$("#stlfile").html("ѡ���ļ���"+current_file);
		  	$("#print").css("display","block");
	  	});
    }

    // ��־��ӡ��ҳ��Ĳ���
    var i = 0;
    console.log = (function(old_funct, div_log) {
        return function(text) {
            old_funct(getNowFormatDate()+": " +text);
            var p = '<p class=\'gray\'>';
            if (typeof text === "object")
                div_log.innerHTML = p + getNowFormatDate()+": " + JSON.stringify(text) + '</p>'+div_log.innerHTML;
            else
                div_log.innerHTML = p+ getNowFormatDate()+": " + text + '</p>'+div_log.innerHTML;

            div_log.scrollTop = div_log.scrollHeight;
            i += 1;
        };
    } (console.log.bind(console), document.getElementById("debug")));
    console.error = console.debug = console.info =  console.log;
	
	//���Ե���
	function debug(txt){
		console.log(txt);
	}
// -->
</script>
</html>
